build_type: fpm

# image: thepackager/test

# fpm build type:
# - fixed package_name
# - fixed package_version (git tag)

package_name: pam_docker
# package_version: $CI_BUILD_TAG || $TRAVIS_TAG || упасть

build_dep: []

before_prepare:
- 'echo "$(date): before_prepare" >> ~/prepare.log'

after_prepare:
- 'echo "$(date): after_prepare" >> ~/prepare.log'

fpm_script:
- when: before_install
  do: echo "BEFORE PACKAGE INSTALL"
- when: after_install
  do: echo "AFTER PACKAGE INSTALL"

os:
  ubuntu:
    prepare:
    - apt-get install -y libpam0g-dev
    fpm_config_files:
      build/etc/security/docker.conf: /etc/security/docker.conf
    fpm_files:
      build/usr/share/pam-configs/docker: /usr/share/pam-configs/docker
      build/lib/security/pam_docker.so: /lib/security/pam_docker.so
    fpm_script:
    - when: before_remove
      do: echo "BEFORE REMOVE"
    - when: [after_install, after_upgrade, after_remove]
      do:
      - echo "updating pam auth ..."
      - pam-auth-update --package
      - echo "updating pam auth DONE"
  centos:
    prepare:
    - yum install -y pam-devel
    fpm_script:
    - on: after_remove
      do: echo 'AFTER REMOVE'

#after_patch:
#- rm debian/patches/lalala.patch

before_build:
- make clean
- make
- DESTDIR=./build make install

target:
- ubuntu
- ubuntu-12.04
- centos
- centos-centos6
