build_type: fpm

package_name: pam_docker
package_version: 0.1.0-1

before_build:
- make
- DESTDIR=build make install

ubuntu:
  prepare:
  - apt-get install -y libpam0g-dev
  fpm_files:
    /usr/share/pam-configs/docker: config/pam_auth_update.conf
    /lib/security/pam_docker.so: build/pam_docker.so
  fpm_script:
  - when: [after_install, after_upgrade, after_remove]
    do: echo "updating pam auth ..." && pam-auth-update --package && echo "updating pam auth OK"

  before_test:
  - git clone https://github.com/sstephenson/bats.git /tmp/bats && /tmp/bats/install.sh /usr/local
  - echo "deb https://apt.dockerproject.org/repo ubuntu-trusty main" >
      /etc/apt/sources.list.d/docker.list
  - apt-get install -y apt-transport-https ca-certificates lxc iptables
  - apt-key adv --keyserver hkp://p80.pool.sks-keyservers.net:80
                --recv-keys 58118E89F3A912897C070ADBF76221572C52609D
  - apt-get update
  - apt-get install -y docker-engine=$DOCKER_VERSION
  - dmsetup mknodes
  - CGROUP=/sys/fs/cgroup SECURITYFS=/sys/kernel/security &&
    (mountpoint -q $CGROUP || mount -n -t tmpfs -o uid=0,gid=0,mode=0755 cgroup $CGROUP) &&
    (mountpoint -q $SECURITYFS || mount -t securityfs none $SECURITYFS) &&
    (for i in {0..200}; do mknod -m0660 /dev/loop$i b 7 $i || true; done)
  - rm -rf /var/lib/docker/*
  - (docker daemon &) && (while ! [ -f /var/run/docker.pid ]; do sleep 1 ; done)

  # run test containers
  - docker run -d --restart=always --name=zabor $DOCKER_TEST_IMAGE /bin/bash -c "while true; do date; sleep 1; done"
  - docker run -d --restart=always --name=turnichok $DOCKER_TEST_IMAGE /bin/bash -c "while true; do date; sleep 1; done"
  - docker run -d --restart=always --name=baran $DOCKER_TEST_IMAGE /bin/bash -c "while true; do date; sleep 1; done"

  # add test group zubilo
  - groupadd zubilo
  - docker exec zabor /bin/bash -c "groupadd zubilo -g $(getent group zubilo | cut -d":" -f3)"
  - docker exec turnichok /bin/bash -c "groupadd zubilo -g $(getent group zubilo | cut -d":" -f3)"

  - kill $(cat /var/run/docker.pid) && COUNTER=0 &&
      (while [ -f /var/run/docker.pid ]; do
        if [ $COUNTER -ge 20 ] ; then
          kill -9 $(cat /var/run/docker.pid) ;
          rm /var/run/docker.pid ;
          break ;
        fi ;
        sleep 1 ;
        let COUNTER=COUNTER+1 ;
      done)

centos:
  prepare:
  - yum install -y pam-devel
  fpm_files:
    /lib64/security/pam_docker.so: build/pam_docker.so

test:
- echo "TEST BEGIN"
- (docker daemon &) && (while ! [ -f /var/run/docker.pid ]; do sleep 1 ; done)
- docker ps
- bats test/
- echo "TEST END"

test_env:
  DOCKER_VERSION: ["1.9.*", "1.10.*", "1.11.*"]
  DOCKER_TEST_IMAGE: ubuntu:14.04

test_options:
  docker:
    privileged: true
    volume: "/tmp/test_docker:/var/lib/docker"

target:
- ubuntu/14.04
- ubuntu/12.04
- centos/centos7
