build_type: fpm

package_name: pam_docker
package_version: 0.1.0-1

before_build:
- make
- DESTDIR=build make install

test_env:
  DOCKER_VERSION: ["1.9.*", "1.10.*", "1.11.*"]

test_options:
  privileged: true

ubuntu:
  prepare:
  - apt-get install -y libpam0g-dev
  fpm_files:
    /usr/share/pam-configs/docker: config/pam_auth_update.conf
    /lib/security/pam_docker.so: build/pam_docker.so
  fpm_script:
  - when: [after_install, after_upgrade, after_remove]
    do: echo "updating pam auth ..." && pam-auth-update --package && echo "updating pam auth OK"

  before_test:
  - echo "deb https://apt.dockerproject.org/repo ubuntu-trusty main" >
      /etc/apt/sources.list.d/docker.list
  - apt-get install -y apt-transport-https ca-certificates
  - apt-key adv
      --keyserver hkp://p80.pool.sks-keyservers.net:80
      --recv-keys 58118E89F3A912897C070ADBF76221572C52609D
  - apt-get update -q
  - apt-get install -y docker-engine=$DOCKER_VERSION
  - docker daemon &

centos:
  prepare:
  - yum install -y pam-devel
  fpm_files:
    /lib64/security/pam_docker.so: build/pam_docker.so

target:
- ubuntu/14.04
- ubuntu/12.04
- centos/centos7
